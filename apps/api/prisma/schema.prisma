generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MASTER
  ADMIN
  EMPLOYEE
}

enum PersonType {
  FISICA
  JURIDICA
  ESTRANGEIRO
}

enum AddressType {
  COMERCIAL
  RESIDENCIAL
}

// Novos Enums para o Módulo Financeiro > Budget
enum BudgetStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  INACTIVE
}

enum DiscountType {
  PERCENT
  VALUE
}

enum PaymentType {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  CASH
  TRANSFER
}

enum CardPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Define onde a tag/template será visível
enum TagScope {
  GLOBAL      // Disponível em Orçamentos e Produção
  BUDGET      // Apenas Orçamentos
  BOARD       // Apenas Produção (Quadros)
}
model User {
  id             String        @id @default(uuid())
  email          String        @unique
  name           String?
  passwordHash   String
  role           Role          @default(EMPLOYEE)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("users")
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  ownerId   String

  users     User[]
  clients   Client[]
  products  Product[]
  budgets   Budget[]
  boards    Board[]
  tags      Tag[]
  templates Template[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  budgetAutoInactive      Boolean @default(false)
  budgetAutoArchive       Boolean @default(false)
  budgetShowTotalInKanban Boolean @default(false)

  // Company Information
  cnpj            String?
  enterpriseName  String?
  fantasyName     String?
  mainEmail     String?
  mainPhone     String?

  // Address
  cep           String?
  address       String?
  addressNumber String?
  complement    String?
  neighborhood  String?
  city          String?
  state         String?
  country       String?   @default("Brasil")

  @@map("organizations")
}

model Client {
  id             String       @id @default(uuid())
  name           String
  fantasyName    String?
  email          String?
  personType     PersonType   @default(FISICA)
  document       String
  stateRegistration String?
  phone          String
  isWhatsapp     Boolean      @default(false)
  rg             String?
  cep            String
  addressType    AddressType?
  address        String
  addressNumber  String
  complement     String?
  neighborhood   String?
  city           String
  state          String
  country        String       @default("Brasil")
  notes          String?
  active         Boolean      @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  budgets        Budget[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([document, organizationId])
  @@map("clients")
}

model Product {
  id             String       @id @default(uuid())
  title          String
  description    String?
  code           String?
  ncm            Decimal?     @db.Decimal(10, 2)
  unitType       String
  costPrice      Decimal
  salePrice      Decimal
  stock          Int
  category       String[]
  active         Boolean      @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  budgetItems    BudgetItem[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("products")
}

model Budget {
  id             String       @id @default(uuid())
  code           Int          @default(autoincrement())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])

  status         BudgetStatus @default(DRAFT)
  expirationDate DateTime?

  discountType   DiscountType?
  discountValue  Decimal?      @db.Decimal(10, 2)
  advancePayment Decimal?      @db.Decimal(10, 2)
  paymentType    PaymentType?

  subtotal       Decimal       @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)

  notes          String?       @db.Text

  items          BudgetItem[]

  // Relação many-to-many com tags
  tags           Tag[]

  // Relação com cards vinculados
  cards          Card[]

  // Anexos do orçamento
  attachments    Attachment[]

  // Public approval link fields
  approvalToken    String?   @unique  // Unique token for public link
  approvedByClient Boolean   @default(false)  // Flag: client vs manual approval
  approvedAt       DateTime?           // When approved/rejected via link
  rejectionReason  String?   @db.Text  // Optional reason if rejected

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?

  archived       Boolean       @default(false)

  @@map("budgets")
}

model BudgetItem {
  id             String       @id @default(uuid())

  budgetId       String
  budget         Budget       @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  productId      String
  product        Product      @relation(fields: [productId], references: [id])

  name           String
  costPrice      Decimal      @db.Decimal(10, 2)

  quantity       Int
  salePrice      Decimal      @db.Decimal(10, 2)

  discountType   DiscountType?
  discountValue  Decimal?      @db.Decimal(10, 2)

  total          Decimal       @db.Decimal(10, 2)

  @@map("budget_items")
}

model Board {
  id             String       @id @default(uuid())
  title          String
  description    String?      @db.Text
  isArchived     Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  columns        BoardColumn[]

  @@map("boards")
}

model BoardColumn {
  id        String   @id @default(uuid())
  title     String
  order     Int

  boardId   String
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  cards     Card[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([boardId])
  @@map("board_columns")
}

model Card {
  id          String       @id @default(uuid())
  title       String
  description String?      @db.Text
  position    Int
  priority    CardPriority? @default(MEDIUM)
  dueDate     DateTime?

  columnId    String
  column      BoardColumn  @relation(fields: [columnId], references: [id], onDelete: Cascade)

  // Vínculo opcional com orçamento aprovado
  budgetId    String?
  budget      Budget?      @relation(fields: [budgetId], references: [id])

  // Checklist items
  checklistItems CardChecklistItem[]

  // Anexos do card
  attachments Attachment[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  tags        Tag[]

  @@index([columnId])
  @@index([budgetId])
  @@map("cards")
}

model CardChecklistItem {
  id          String   @id @default(uuid())

  cardId      String
  card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  name        String
  isCompleted Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cardId])
  @@map("card_checklist_items")
}

model Tag {
  id             String   @id @default(uuid())
  name           String
  color          String   // Formato HEX. Ex: "#EF4444"

  // Escopo de utilização da tag
  scope          TagScope @default(GLOBAL)

  // Soft delete e controle de disponibilidade
  active         Boolean  @default(true)

  // Relacionamento Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relação many-to-many com Budget
  budgets        Budget[]
  cards          Card[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?

  // Garante que não existam duas tags com o mesmo nome na mesma empresa
  @@unique([name, organizationId])
  @@map("tags")
}

enum TemplateScope {
  GLOBAL
  BOARD
  BUDGET
}

model Attachment {
  id          String   @id @default(uuid())
  name        String                    // Nome original do arquivo
  url         String                    // URL pública do arquivo
  key         String   @unique          // Key do storage (para deletar)
  size        Int                       // Tamanho em bytes
  mimeType    String?                   // Tipo MIME (image/png, application/pdf, etc.)

  // Relacionamento polimórfico - um anexo pertence a Budget OU Card
  budgetId    String?
  budget      Budget?  @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  cardId      String?
  card        Card?    @relation(fields: [cardId], references: [id], onDelete: Cascade)

  // Referência ao attachment original do budget (quando é cópia)
  // Se preenchido, indica que este attachment é uma referência e não deve deletar o arquivo físico
  sourceBudgetAttachmentId String?

  // Multi-tenant
  organizationId String

  createdAt   DateTime @default(now())

  @@index([budgetId])
  @@index([cardId])
  @@index([organizationId])
  @@map("attachments")
}

model Template {
  id        String        @id @default(cuid())
  name      String
  content   String        @db.Text
  scope     TemplateScope

  // Soft delete e controle de disponibilidade
  active    Boolean       @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?

  // Garante que não existam dois templates com o mesmo nome na mesma empresa
  @@unique([name, organizationId])
  @@map("templates")
  @@index([scope])
}
